<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYBNK GAME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ОСНОВНЫЕ СТИЛИ - СОВРЕМЕННЫЙ ДИЗАЙН */
        :root {
            /* ТЁМНАЯ ТЕМА (по умолчанию) */
            --bg-primary: #0A0A0F;
            --bg-secondary: #15151F;
            --bg-card: rgba(30, 30, 45, 0.6);
            --accent-blue: #00D4FF;
            --accent-pink: #FF2D75;
            --accent-purple: #8B5CF6;
            --accent-gold: #FFD700;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0B0;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --neon-glow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 30px #ffffff;

            /* РАЗМЕР АВАТАРКИ */
            --avatar-size: 200px;
            --avatar-margin-top: -25px;
            --avatar-margin-bottom: 20px;
        }

        /* СВЕТЛАЯ ТЕМА */
        body.light-theme {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-card: rgba(255, 255, 255, 0.9);
            --accent-blue: #007AFF;
            --accent-pink: #FF375F;
            --accent-purple: #5856D6;
            --accent-gold: #FF9500;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(0, 122, 255, 0.2);
            --neon-glow: 0 0 10px rgba(0, 122, 255, 0.5), 0 0 20px rgba(0, 122, 255, 0.3);
        }

        /* НЕОНОВАЯ ТЕМА */
        body.neon-theme {
            --bg-primary: #000000;
            --bg-secondary: #050510;
            --bg-card: rgba(0, 212, 255, 0.05);
            --accent-blue: #00FFFF;
            --accent-pink: #FF00FF;
            --accent-purple: #BF00FF;
            --accent-gold: #FFFF00;
            --text-primary: #FFFFFF;
            --text-secondary: #A0F0FF;
            --border-color: rgba(0, 212, 255, 0.3);
            --shadow-glow: 0 0 20px rgba(0, 255, 255, 0.5);
            --neon-glow: 0 0 10px #00FFFF, 0 0 20px #00FFFF, 0 0 30px #00FFFF;
        }

        /* Фон для неоновой темы */
        .neon-theme::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(191, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 0, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Дополнительные эффекты для неоновой темы */
        .neon-theme .click-area {
            animation: neon-pulse-button 2s infinite alternate;
        }

        @keyframes neon-pulse-button {
            from {
                box-shadow:
                    0 20px 40px rgba(0, 212, 255, 0.3),
                    0 0 0 0 rgba(0, 255, 255, 0.5);
            }
            to {
                box-shadow:
                    0 20px 40px rgba(0, 212, 255, 0.3),
                    0 0 0 15px rgba(0, 255, 255, 0);
            }
        }

        .neon-theme .boost-button {
            animation: neon-gold-pulse 2s infinite alternate;
        }

        @keyframes neon-gold-pulse {
            from {
                box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
            }
        }

        .neon-theme .stat-value,
        .neon-theme .balance-amount,
        .neon-theme #discountValue {
            animation: neon-text-pulse 2s infinite alternate;
        }

        @keyframes neon-text-pulse {
            from {
                text-shadow:
                    0 0 5px #ffffff,
                    0 0 10px #ffffff,
                    0 0 15px var(--accent-blue);
            }
            to {
                text-shadow:
                    0 0 10px #ffffff,
                    0 0 20px #ffffff,
                    0 0 30px var(--accent-blue),
                    0 0 40px var(--accent-blue);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: manipulation;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Фон с градиентом и текстурой */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 45, 117, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        /* Основной контейнер */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 5px 15px 80px;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Плавный переход между темами */
        body, .container, .balance-card, .stat-card, .upgrade-item,
        .shop-item, .bonus-item, .video-card, .nav-tabs {
            transition: background-color 0.5s ease,
                        border-color 0.5s ease,
                        color 0.5s ease,
                        box-shadow 0.5s ease;
        }

        .click-area, .boost-button, .modern-button, .shop-button {
            transition: all 0.5s ease;
        }

        /* СОВРЕМЕННЫЙ ХЕДЕР */
        .header {
            padding: 10px 0 5px 0;
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .logo {
            font-size: 1.3em;
            margin: 0;
            color: #FFD700;
        }

        .level-badge {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
            color: var(--accent-blue);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .level-badge:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        /* КАРТОЧКА БАЛАНСА С БУСТОМ */
        .balance-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .balance-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            margin-bottom: 15px;
        }

        .balance-info {
            flex: 1;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
        }

        .balance-title {
            font-size: 1em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
            margin-top: 5px;
        }

        .balance-amount {
            font-size: 2.8em;
            font-weight: 800;
            margin: 5px 0;
            color: #FFFFFF;
        }

        .balance-subtitle {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* КНОПКА БУСТА */
        .boost-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: auto;
        }

        .boost-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-gold), #FFA500);
            border: none;
            color: white;
            font-weight: 800;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: boostPulse 2s infinite;
        }

        @keyframes boostPulse {
            0% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
                transform: scale(1);
            }
        }

        .boost-button:disabled {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            animation: none;
            box-shadow: none;
            transform: scale(1);
        }

        .boost-button.active {
            background: linear-gradient(135deg, #00FF00, #00CC00);
            animation: activeBoost 1s infinite;
        }

        @keyframes activeBoost {
            0% {
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 255, 0, 0.8);
                transform: scale(1.1);
            }
            100% {
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
                transform: scale(1);
            }
        }

        .boost-timer {
            font-size: 0.7em;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: center;
            min-height: 20px;
            min-width: 80px;
        }

        .boost-active-timer {
            font-size: 0.8em;
            color: #00FF00;
            font-weight: bold;
            margin-top: 5px;
        }

        /* СЕКЦИЯ ЭНЕРГИИ */
        .energy-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0 5px 0;
        }

        .energy-bar-container {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .energy-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 100%;
            position: relative;
        }

        .energy-text {
            font-size: 0.9em;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            color: var(--accent-blue);
        }

        /* ПРОГРЕСС БАР УРОВНЯ */
        .level-progress-section {
            margin: 8px 0 0 0;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            height: 100%;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ОБНОВЛЕННЫЙ СТИЛЬ ДЛЯ БЛОКА СКИДКИ */
        .discount-section {
            margin: 15px 0;
        }

        .discount-bar {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .discount-bar:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .discount-text {
            color: var(--text-primary);
            font-size: 0.9em;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #discountValue {
            color: #FFFFFF;
            font-weight: 800;
            font-size: 1em;
            text-shadow:
                0 0 5px #ffffff,
                0 0 10px #ffffff,
                0 0 15px #ffffff,
                0 0 20px var(--accent-blue),
                0 0 35px var(--accent-blue),
                0 0 40px var(--accent-blue);
            animation: neonPulse 2s infinite alternate;
        }

        @keyframes neonPulse {
            from {
                text-shadow:
                    0 0 5px #ffffff,
                    0 0 10px #ffffff,
                    0 0 15px #ffffff,
                    0 0 20px var(--accent-blue);
            }
            to {
                text-shadow:
                    0 0 10px #ffffff,
                    0 0 20px #ffffff,
                    0 0 30px #ffffff,
                    0 0 40px var(--accent-blue),
                    0 0 70px var(--accent-blue);
            }
        }

        /* ГЛАВНАЯ КНОПКА */
        .click-area {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            border-radius: 50%;
            width: 220px;
            height: 220px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow:
                0 20px 40px rgba(0, 212, 255, 0.3),
                0 0 0 0 rgba(0, 212, 255, 0.5);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow:
                    0 20px 40px rgba(0, 212, 255, 0.3),
                    0 0 0 0 rgba(0, 212, 255, 0.5);
            }
            70% {
                box-shadow:
                    0 20px 40px rgba(0, 212, 255, 0.3),
                    0 0 0 15px rgba(0, 212, 255, 0);
            }
            100% {
                box-shadow:
                    0 20px 40px rgba(0, 212, 255, 0.3),
                    0 0 0 0 rgba(0, 212, 255, 0);
            }
        }

        .click-area:hover {
            transform: scale(1.05);
        }

        .click-area:active {
            transform: scale(0.95);
        }

        .click-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .click-area.disabled:active {
            transform: scale(1);
        }

        .click-text {
            font-size: 1.8em;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* СЕТКА СТАТИСТИКИ */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .stat-card div:first-child {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: 800;
            margin-top: 5px;
            color: #FFFFFF;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7),
                        0 0 20px rgba(255, 255, 255, 0.5),
                        0 0 30px rgba(255, 255, 255, 0.3);
            animation: neonPulse 2s infinite alternate;
        }

        /* НАВИГАЦИЯ ВНИЗУ */
        .nav-tabs {
            display: flex;
            background: rgba(30, 30, 45, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 15px;
            padding: 5px;
            margin: 20px 0;
            gap: 2px;
            border: 1px solid var(--border-color);
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-tab.active {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-blue);
            border: 1px solid rgba(0, 212, 255, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-blue);
        }

        .nav-icon {
            font-size: 1.1em;
            margin-bottom: 2px;
        }

        .nav-text {
            font-size: 0.75em;
            line-height: 1.1;
        }

        /* СОДЕРЖАНИЕ ВКЛАДОК */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* КОНТЕНТ ВКЛАДОК */
        .tab-content-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        .tab-content-header h2 {
            color: var(--accent-blue);
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .tab-content-header p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        /* БАЛАНС НА ВКЛАДКАХ */
        .tab-balance {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .tab-balance-title {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .tab-balance-amount {
            font-size: 2em;
            font-weight: 800;
            margin: 5px 0;
            color: #FFFFFF;
        }

        .tab-balance-subtitle {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        /* КАРТОЧКИ УЛУЧШЕНИЙ */
        .upgrade-item {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .upgrade-item:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upgrade-name {
            font-size: 1em;
            font-weight: 700;
            flex: 1;
            color: var(--accent-blue);
        }

        .upgrade-level {
            background: rgba(0, 212, 255, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            min-width: 60px;
            text-align: center;
            color: var(--accent-blue);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .upgrade-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* КНОПКИ */
        .modern-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }

        .modern-button:active {
            transform: translateY(0);
        }

        .modern-button:disabled {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* КАРТОЧКИ МАГАЗИНА */
        .shop-item {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .shop-item:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .shop-item-name {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            flex: 1;
        }

        .shop-item-description {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 0.85em;
            line-height: 1.4;
            flex: 1;
        }

        .shop-item-price {
            font-size: 1.2em;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--accent-blue);
        }

        /* МАЛЕНЬКАЯ КНОПКА ДЛЯ МАГАЗИНА */
        .shop-button {
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
            width: 100%;
            white-space: nowrap;
        }

        .shop-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 212, 255, 0.4);
        }

        .shop-button:active {
            transform: translateY(0);
        }

        .shop-button:disabled {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* СЕТКА МАГАЗИНА */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* БОНУСНЫЕ КАРТОЧКИ */
        .bonus-item {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .bonus-item:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .bonus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bonus-name {
            font-size: 1em;
            font-weight: 700;
            flex: 1;
            color: var(--accent-blue);
        }

        .bonus-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* ТОВАР НЕДЕЛИ */
        .featured-item {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            padding: 2px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .featured-item-content {
            background: var(--bg-card);
            border-radius: 13px;
            padding: 20px;
            text-align: center;
        }

        .featured-badge {
            background: linear-gradient(135deg, var(--accent-gold), #FFA500);
            color: black;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 15px;
        }

        /* КВАДРАТНЫЕ ИЗОБРАЖЕНИЯ ДЛЯ МАГАЗИНА */
        .square-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .square-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            display: block;
        }

        .shop-item:hover .square-image img {
            transform: scale(1.05);
        }

        /* Исправления для рейтинга */
        .rating-list {
            width: 100%;
            margin: 10px 0;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            gap: 15px;
        }

        .rating-item:last-child {
            border-bottom: none;
        }

        .rating-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px 8px;
        }

        .rating-user {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .rating-username {
            color: var(--accent-blue);
            font-weight: 600;
            white-space: nowrap;
            overflow: visible;
            text-overflow: unset;
            max-width: none;
            flex-shrink: 0;
        }

        .rating-balance {
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            margin-left: 10px;
            flex-shrink: 0;
            min-width: 100px;
            text-align: right;
        }

        /* БЛОК НОВОГО ВИДЕО */
        .video-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .video-card:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-glow);
        }

        .video-thumbnail {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .video-thumbnail img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }

        .video-thumbnail:hover img {
            transform: scale(1.05);
        }

        .video-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-thumbnail:hover .video-play-overlay {
            opacity: 1;
        }

        .play-icon {
            font-size: 3em;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* СТАТИСТИКА ПРОФИЛЯ */
        .profile-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .profile-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .profile-stat-value {
            color: var(--accent-blue);
            font-weight: 700;
            font-size: 0.9em;
        }

        /* БЛОК АВАТАРКИ */
        .avatar-section {
            margin: var(--avatar-margin-top) 0 var(--avatar-margin-bottom) 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .avatar-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar-image {
            width: var(--avatar-size) !important;
            height: var(--avatar-size) !important;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }

        .avatar-image:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }

        .avatar-placeholder {
            width: var(--avatar-size) !important;
            height: var(--avatar-size) !important;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--avatar-size) * 0.4);
            color: var(--text-secondary);
            border: 3px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 0 auto;
        }

        .avatar-placeholder:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .avatar-controls,
        .avatar-buttons,
        .avatar-slider,
        .avatar-button {
            display: none !important;
        }

        .avatar-button:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-blue);
        }

        /* СЕТКА АВАТАРОВ */
        .avatars-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .avatar-option:hover {
            border-color: var(--accent-blue);
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px var(--accent-blue);
        }

        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ЗАГРУЗКА ФОТО */
        .upload-section {
            margin: 15px 0;
            text-align: center;
        }

        .upload-button {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
            width: auto;
            min-width: 140px;
            text-align: center;
            border: none;
            margin: 10px auto 0 auto;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 212, 255, 0.4);
        }

        .sync-section,
        .reset-section,
        .reply-buttons {
            display: none !important;
        }

        .upload-input {
            display: none;
        }

        /* ЭФФЕКТЫ КЛИКА */
        .click-effect {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: clickAnimation 0.5s ease-out;
            pointer-events: none;
        }

        @keyframes clickAnimation {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }

        .floating-reward {
            position: absolute;
            font-size: 1.4em;
            font-weight: 800;
            color: var(--accent-blue);
            pointer-events: none;
            z-index: 10;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(1.2);
            }
        }

        /* БУСТ ЭФФЕКТЫ */
        .boost-active-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .boost-active-indicator.active {
            opacity: 1;
        }

        /* ПОПАПЫ */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .popup-content {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .popup-header {
            font-size: 1.5em;
            font-weight: 800;
            margin-bottom: 15px;
            text-align: center;
            color: var(--accent-blue);
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .popup-button {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }

        .popup-button.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* Стили для кнопки "Посмотреть весь каталог" */
        #shop-tab {
            position: relative;
            padding-bottom: 100px;
        }

        .catalog-button-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            width: 100%;
        }

        .catalog-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 320px;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .catalog-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .catalog-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5);
        }

        .catalog-button:hover::before {
            left: 100%;
        }

        .catalog-button:active {
            transform: translateY(-1px);
        }

        .catalog-button-text {
            font-weight: 700;
            white-space: nowrap;
        }

        .catalog-button-icon {
            font-size: 1.3em;
            transition: transform 0.3s ease;
        }

        .catalog-button:hover .catalog-button-icon {
            transform: translateX(3px);
        }

        /* ЭКРАН ЗАГРУЗКИ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            font-size: 3em;
            font-weight: 900;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            line-height: 1.2;
        }

        .loading-container {
            text-align: center;
            width: 80%;
            max-width: 300px;
        }

        .loading-text {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .loading-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .loading-percentage {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* ПОПАП ПОДГОТОВКИ */
        .preparation-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .preparation-popup h3 {
            color: var(--accent-blue);
            font-size: 1.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .preparation-popup p {
            color: var(--text-secondary);
            text-align: center;
        }

        /* ===== ПЕРЕКЛЮЧАТЕЛЬ ТЕМ ===== */
        .theme-switcher {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 8px;
            gap: 8px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            justify-content: space-between;
        }

        .theme-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            min-height: 70px;
        }

        .theme-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-blue);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
        }

        .theme-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
            transform: scale(1.05);
        }

        .theme-btn.active .theme-icon {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .theme-icon {
            font-size: 1.8em;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }

        .theme-label {
            font-size: 0.85em;
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
        }

        /* Особые стили для неоновой темы кнопок */
        .neon-theme .theme-btn {
            background: rgba(0, 212, 255, 0.05);
            border: 2px solid rgba(0, 212, 255, 0.3);
        }

        .neon-theme .theme-btn:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.7);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
        }

        .neon-theme .theme-btn.active {
            background: rgba(0, 212, 255, 0.3);
            border-color: var(--accent-blue);
            box-shadow:
                0 0 20px rgba(0, 212, 255, 0.6),
                inset 0 0 10px rgba(0, 212, 255, 0.2);
            animation: neon-pulse 2s infinite alternate;
        }

        @keyframes neon-pulse {
            from {
                box-shadow:
                    0 0 20px rgba(0, 212, 255, 0.6),
                    inset 0 0 10px rgba(0, 212, 255, 0.2);
            }
            to {
                box-shadow:
                    0 0 25px rgba(0, 212, 255, 0.8),
                    inset 0 0 15px rgba(0, 212, 255, 0.3);
            }
        }

        /* Стили для светлой темы */
        .light-theme .theme-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .light-theme .theme-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .light-theme .theme-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Адаптивность для переключателя тем */
        @media (max-width: 480px) {
            .theme-switcher {
                padding: 6px;
                gap: 6px;
            }

            .theme-btn {
                padding: 10px 6px;
                min-height: 60px;
            }

            .theme-icon {
                font-size: 1.5em;
            }

            .theme-label {
                font-size: 0.75em;
            }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 480px) {
            .rating-username {
                font-size: 0.9em;
                max-width: 150px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .rating-item {
                gap: 8px;
                padding: 10px 0;
            }

            .container {
                padding: 5px 10px 80px;
            }

            .click-area {
                width: 200px;
                height: 200px;
            }

            .balance-amount {
                font-size: 2.5em;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .boost-button {
                width: 50px;
                height: 50px;
                font-size: 0.7em;
            }

            .balance-info {
                width: 50%;
            }

            .shop-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .shop-item {
                padding: 12px;
            }

            .shop-item-image {
                height: 120px;
            }

            .shop-item-name {
                font-size: 1em;
            }

            .shop-item-description {
                font-size: 0.8em;
            }

            .avatars-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .avatar-option {
                width: 70px;
                height: 70px;
            }

            .avatar-image, .avatar-placeholder {
                width: var(--avatar-size) !important;
                height: var(--avatar-size) !important;
            }
        }

        @media (max-width: 360px) {
            .rating-username {
                max-width: 120px;
                font-size: 0.85em;
            }

            .rating-balance {
                font-size: 0.85em;
                min-width: 70px;
            }

            .container {
                padding: 5px 8px 80px;
            }

            .click-area {
                width: 180px;
                height: 180px;
            }

            .balance-amount {
                font-size: 2.2em;
            }

            .boost-button {
                width: 45px;
                height: 45px;
                font-size: 0.65em;
            }

            .balance-info {
                width: 45%;
            }

            .shop-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Экран загрузки -->
    <div id="loading-screen">
        <div class="loading-logo">
            KYBNK<br>GAME
        </div>

        <div class="loading-container">
            <div class="loading-text">Загрузка игры...</div>

            <div class="loading-bar-container">
                <div class="loading-bar" id="loadingBar"></div>
            </div>

            <div class="loading-percentage" id="loadingPercentage">0%</div>
        </div>
    </div>

    <!-- Индикатор активного буста -->
    <div class="boost-active-indicator" id="boostActiveIndicator"></div>

    <!-- Основной контент -->
    <div class="container">
        <!-- Контент главной вкладки -->
        <div class="tab-content active" id="main-tab">
            <!-- Заголовок и баланс только на главной -->
            <div class="header">
                <div class="header-content">
                    <h1 class="logo">KYBNK GAME</h1>
                    <div class="level-badge" onclick="showLevelsInfo()">
                        Новичок 🟢
                    </div>
                </div>
            </div>

            <!-- Карточка баланса с кнопкой буста -->
            <div class="balance-card">
                <div class="balance-content">
                    <div class="balance-info">
                        <div class="balance-title">Ваш баланс</div>
                        <div class="balance-amount" id="balance">0</div>
                        <div class="balance-subtitle">токенов</div>
                    </div>
                    <div class="boost-section">
                        <button class="boost-button" id="boostButton" onclick="activateBoost()">
                            BOOST
                        </button>
                        <div class="boost-timer" id="boostTimer"></div>
                    </div>
                </div>

                <!-- Секция энергии -->
                <div class="energy-section">
                    <div class="energy-bar-container">
                        <div class="energy-bar" id="energyBar" style="width: 100%"></div>
                    </div>
                    <div class="energy-text" id="energyText">100/100</div>
                </div>

                <!-- Прогресс уровня -->
                <div class="level-progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="levelProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="levelProgressText">0% до след. уровня</div>
                </div>
            </div>

            <!-- Главная кнопка и статистика ТОЛЬКО на главной -->
            <div class="click-area" id="clickButton">
                <div class="click-text">КЛИК!</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div>Всего кликов</div>
                    <div class="stat-value" id="clicks">0</div>
                </div>
                <div class="stat-card">
                    <div>Общий заработок</div>
                    <div class="stat-value" id="totalEarned">0</div>
                </div>
            </div>

            <!-- ОБНОВЛЕННЫЙ БЛОК СКИДКИ -->
            <div class="discount-section">
                <div class="discount-bar">
                    <div class="discount-text">Ваша персональная скидка в магазине: <span id="discountValue">0</span>%</div>
                </div>
            </div>

            <!-- Система бонусов -->
            <div style="margin-top: 20px;">
                <h3 style="text-align: center; margin-bottom: 15px; color: var(--accent-blue);">🎁 Бонусы за подписку</h3>

                <div class="bonus-item">
                    <div class="bonus-header">
                        <div class="bonus-name">Подпишись на @kybnk_show</div>
                    </div>
                    <div class="bonus-description">Получи 1000 токенов за подписку на наш основной канал</div>
                    <button class="modern-button" onclick="subscribeAndClaimBonus('kybnk_show')" id="bonusKybnkShow">
                        Получить 1000 токенов
                    </button>
                </div>

                <div class="bonus-item">
                    <div class="bonus-header">
                        <div class="bonus-name">Подпишись на @kybnk_shop</div>
                    </div>
                    <div class="bonus-description">Получи 1000 токенов за подписку на наш магазин</div>
                    <button class="modern-button" onclick="subscribeAndClaimBonus('kybnk_shop')" id="bonusKybnkShop">
                        Получить 1000 токенов
                    </button>
                </div>
            </div>

            <!-- Блок нового видео -->
            <div class="video-card">
                <h2 style="color: var(--accent-blue); margin-bottom: 15px;">🎬 Новое видео на канале</h2>
                <div class="video-thumbnail" onclick="openVideo()">
                    <img src="https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/video.jpg"
                         alt="Обложка нового видео"
                         id="videoThumbnail">
                    <div class="video-play-overlay">
                        <div class="play-icon">▶</div>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Нажмите на обложку, чтобы перейти к просмотру</p>
            </div>
        </div>

        <!-- Вкладка Улучшений -->
        <div class="tab-content" id="upgrades-tab">
            <div class="tab-content-header">
                <h2>🚀 Улучшения</h2>
                <p>Прокачивайте свои возможности и увеличивайте доход</p>

                <!-- Баланс на вкладке улучшений -->
                <div class="tab-balance">
                    <div class="tab-balance-title">Ваш баланс</div>
                    <div class="tab-balance-amount" id="upgradesBalance">0</div>
                    <div class="tab-balance-subtitle">токенов</div>
                </div>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">🖱️ Улучшенный клик</div>
                    <div class="upgrade-level">Ур. <span id="clickPowerLevel">1</span></div>
                </div>
                <div class="upgrade-description">+1 токен за каждый уровень улучшения</div>
                <button class="modern-button" onclick="buyUpgrade('click_power')" id="clickPowerButton">
                    Купить за <span id="clickPowerPrice">100</span> токенов
                </button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">💤 Пассивный доход</div>
                    <div class="upgrade-level">Ур. <span id="passiveLevel">0</span></div>
                </div>
                <div class="upgrade-description">+1 токен в час за каждый уровень (работает даже когда приложение закрыто)</div>
                <button class="modern-button" onclick="buyUpgrade('passive')" id="passiveButton">
                    Купить за <span id="passivePrice">200</span> токенов
                </button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">⚡ Автокликер</div>
                    <div class="upgrade-level">Ур. <span id="autoclickLevel">0</span></div>
                </div>
                <div class="upgrade-description">Автоматические клики каждую минуту (+0.5 токена за уровень)</div>
                <button class="modern-button" onclick="buyUpgrade('autoclick')" id="autoclickButton">
                    Купить за <span id="autoclickPrice">500</span> токенов
                </button>
            </div>

            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">🔋 Лимит энергии</div>
                    <div class="upgrade-level">Ур. <span id="energyLimitLevel">0</span></div>
                </div>
                <div class="upgrade-description">+50 к максимальной энергии за каждый уровень</div>
                <button class="modern-button" onclick="buyUpgrade('energy_limit')" id="energyLimitButton">
                    Купить за <span id="energyLimitPrice">300</span> токенов
                </button>
            </div>
        </div>

        <!-- Вкладка Магазина -->
        <div class="tab-content" id="shop-tab">
            <div class="tab-content-header">
                <h2>🛍️ Магазин</h2>
                <p>Самый быстрый из Вас сможет забрать товар из нашего магазина абсолютно бесплатно</p>

                <!-- РЕЙТИНГ ИГРОКОВ - УМНАЯ СИСТЕМА -->
                <div class="tab-balance">
                    <div class="tab-balance-title">🏆 Топ игроков</div>

                    <div class="rating-list" id="smartRatingList" style="width: 100%; margin: 10px 0;">
                        <!-- Динамически загружается -->
                        <div class="loading">Загрузка рейтинга...</div>
                    </div>
                    <div class="tab-balance-subtitle" style="margin-top: 10px;"> </div>
                </div>
            </div>

            <!-- Товар недели -->
            <div class="featured-item">
                <div class="featured-item-content">
                    <div class="featured-badge">⭐ ТОВАР НЕДЕЛИ</div>
                    <div class="shop-item" style="background: rgba(0, 212, 255, 0.1); border: 2px solid var(--accent-blue);">
                        <div class="square-image">
                            <img src="https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph1.jpg"
                                 alt="Товар недели"
                                 onerror="this.src='https://via.placeholder.com/300x300/15151F/FFFFFF?text=🔥'">
                        </div>
                        <div class="shop-item-name" style="color: var(--accent-blue);">ТОВАР ЗА ТОКЕНЫ</div>
                        <div class="shop-item-description">Получите его бесплатно, обменяв его на токены, или подберите что-то новое в свой гардероб, выбрав себе товар ниже</div>
                        <div class="shop-item-price">1,200,000 токенов</div>
                        <button class="shop-button" onclick="exchangeForTokens()" style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));">
                            Обменять на токены
                        </button>

                        <!-- БЛОК ПОБЕДИТЕЛЯ -->
                        <div class="winner-section" style="margin-top: 20px;">
                            <div class="winner-info" style="padding: 12px; background: rgba(30, 30, 45, 0.6); border-radius: 8px; border: 1px solid var(--border-color); text-align: center;">
                                <div style="color: var(--text-secondary); font-size: 0.85em;">
                                    🏆 Товар забрал: <span id="winnerUsername" style="color: var(--accent-blue);">-</span>
                                </div>
                            </div>

                            <!-- ТАЙМЕР -->
                            <div class="reset-timer" style="margin-top: 8px; color: var(--text-secondary); font-size: 0.75em; text-align: center;">
                                🔄 Новый товар через: <span id="resetTimer">30 дней</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Все товары -->
            <h3 style="color: var(--text-primary); margin: 25px 0 15px 0; text-align: center;">Все товары</h3>
            <div class="shop-grid" id="shop-items">
                <!-- Товары будут загружены динамически -->
            </div>

            <!-- КНОПКА ПОСМОТРЕТЬ ВЕСЬ КАТАЛОГ -->
            <div class="catalog-button-container">
                <button class="catalog-button" onclick="openFullCatalog()">
                    <span class="catalog-button-text">Посмотреть весь каталог</span>
                    <span class="catalog-button-icon">→</span>
                </button>
            </div>
        </div>

        <!-- Вкладка Профиля -->
        <div class="tab-content" id="profile-tab">
            <div class="tab-content-header">
                <h2>👤 Ваш профиль</h2>
                <p>Вы можете изменить аватар своего профиля, нажав на иконку</p>
            </div>

            <!-- УПРОЩЕННЫЙ БЛОК АВАТАРКИ -->
            <div class="avatar-section">
                <div class="avatar-container">
                    <img id="avatarImage" class="avatar-image" src="" alt="Аватар" style="display: none;">
                    <div id="avatarPlaceholder" class="avatar-placeholder" onclick="document.getElementById('avatarUploadInput').click()">
                        👤
                    </div>
                </div>
                <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">

                <!-- ПРОСТАЯ КНОПКА ЗАГРУЗКИ -->
                <button class="upload-button" onclick="document.getElementById('avatarUploadInput').click()">
                    📁 Загрузить аватар
                </button>
            </div>

            <!-- Статистика пользователя -->
            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">📊 Статистика</div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat-row">
                        <span class="profile-stat-label">Текущий уровень:</span>
                        <strong class="profile-stat-value" id="profileLevel">Новичок 🟢</strong>
                    </div>
                    <div class="profile-stat-row">
                        <span class="profile-stat-label">Всего заработано:</span>
                        <strong class="profile-stat-value" id="profileTotal">0 токенов</strong>
                    </div>
                    <div class="profile-stat-row">
                        <span class="profile-stat-label">Всего кликов:</span>
                        <strong class="profile-stat-value" id="profileClicks">0</strong>
                    </div>
                    <div class="profile-stat-row">
                        <span class="profile-stat-label">Рефералы:</span>
                        <strong class="profile-stat-value" id="profileReferrals">0</strong>
                    </div>
                    <div class="profile-stat-row">
                        <span class="profile-stat-label">Следующий уровень:</span>
                        <strong class="profile-stat-value" id="profileNextLevel">1000 кликов</strong>
                    </div>
                </div>
            </div>

            <!-- Реферальная система -->
            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">👥 Реферальная система</div>
                </div>
                <div class="upgrade-description" style="color: var(--text-primary);">
                    <strong>Приглашайте друзей и получайте бонусы!</strong><br><br>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 10px; border-radius: 8px; margin: 5px 0;">
                        ✅ <strong>Вы получаете:</strong> 2000 токенов за каждого друга
                    </div>
                    <div style="background: rgba(255, 45, 117, 0.1); padding: 10px; border-radius: 8px; margin: 5px 0;">
                        🎁 <strong>Друг получает:</strong> 1000 токенов при регистрации
                    </div>
                </div>
                <button class="modern-button" onclick="showReferral()" style="margin-top: 10px;">
                    📋 Показать реферальную ссылку
                </button>
            </div>

            <!-- Обмен токенов -->
            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">💎 Обмен токенов</div>
                </div>
                <div class="upgrade-description" style="color: var(--text-primary);">
                    <strong>Обменяй токены на скидки в нашем магазине:</strong><br><br>
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 8px; margin: 5px 0;">
                        • <strong>1000 токенов</strong> = 100 рублей скидки
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 8px; margin: 5px 0;">
                        • <strong>5000 токенов</strong> = 600 рублей скидки
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 8px; margin: 5px 0;">
                        • <strong>10000 токенов</strong> = 1300 рублей скидки
                    </div>
                </div>
                <button class="modern-button" onclick="showExchange()" style="margin-top: 10px;">
                    💰 Обменять токены
                </button>
            </div>

            <!-- Переключатель тем -->
            <div class="upgrade-item">
                <div class="upgrade-header">
                    <div class="upgrade-name">🎨 Тема игры</div>
                </div>
                <div class="upgrade-description" style="color: var(--text-primary);">
                    <strong>Выберите тему интерфейса:</strong><br>
                    Вы можете переключаться между темами в любое время
                </div>

                <!-- Переключатель тем -->
                <div class="theme-switcher">
                    <button class="theme-btn active" data-theme="dark" onclick="switchTheme('dark')">
                        <div class="theme-icon">🌙</div>
                        <div class="theme-label">Тёмная</div>
                    </button>
                    <button class="theme-btn" data-theme="light" onclick="switchTheme('light')">
                        <div class="theme-icon">☀️</div>
                        <div class="theme-label">Светлая</div>
                    </button>
                    <button class="theme-btn" data-theme="neon" onclick="switchTheme('neon')">
                        <div class="theme-icon">💡</div>
                        <div class="theme-label">Неоновая</div>
                    </button>
                </div>
            </div>

        </div>

        <!-- Навигация ВНИЗУ -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="main">
                <div class="nav-icon">⭐</div>
                <div class="nav-text">Главная</div>
            </div>
            <div class="nav-tab" data-tab="upgrades">
                <div class="nav-icon">🚀</div>
                <div class="nav-text">Улучшения</div>
            </div>
            <div class="nav-tab" data-tab="shop">
                <div class="nav-icon">🛍️</div>
                <div class="nav-text">Магазин</div>
            </div>
            <div class="nav-tab" data-tab="profile">
                <div class="nav-icon">👤</div>
                <div class="nav-text">Профиль</div>
            </div>
        </div>
    </div>

    <!-- Попап подготовки заявки -->
    <div id="preparationPopup" class="preparation-popup">
        <div class="preparation-content">
            <h3>Подготовка заявки...</h3>
            <p>Пожалуйста, подождите</p>
        </div>
    </div>

    <script>
        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        console.log('Скрипт начал выполняться');

        // Основные переменные
        let userData = {
            balance: 0,
            level: 1,
            level_name: "Новичок 🟢",
            clicks: 0,
            total_earned: 0,
            referrals: 0,
            passive_income: 0,
            upgrades: {
                click_power: 1,
                passive: 0,
                autoclick: 0,
                energy_limit: 0
            },
            next_level_progress: 0,
            next_level_threshold: 1000,
            bonuses: {
                kybnk_show: false,
                kybnk_shop: false
            },
            last_passive_claim: Date.now(),
            energy: 100,
            max_energy: 100,
            last_energy_update: Date.now(),
            boost: {
                available: true,
                lastUsed: 0,
                active: false,
                endTime: 0,
                cooldownEnd: 0,
                multiplier: 1
            },
            discount: 0,
            user_id: null,
            username: null
        };

        let telegramUser = null;
        let clickCooldown = false;
        let currentBonusChannel = null;
        let verificationAttempts = {};
        let lastReferralCount = 0;
        let selectedAvatarIndex = -1;

        // Максимальные уровни для улучшений
        const maxLevels = {
            click_power: 11,
            passive: 20,
            autoclick: 10,
            energy_limit: 16
        };

        // Цены улучшений
        const upgradePrices = {
            click_power: 100,
            passive: 200,
            autoclick: 500,
            energy_limit: 300
        };

        // Настройки буста
        const BOOST_SETTINGS = {
            DURATION: 30000,
            COOLDOWN: 2 * 60 * 60 * 1000,
            MULTIPLIER: 2
        };

        // Интервалы
        let energyInterval = null;
        let boostInterval = null;
        let uiUpdateInterval = null;
        let autoClickerInterval = null;
        let autoSaveInterval = null;

        // Предустановленные аватары
        const presetAvatars = [
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Destiny',
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Luis',
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Eliza',
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Nolan',
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Easton',
            'https://api.dicebear.com/9.x/fun-emoji/svg?seed=Christian'
        ];

        // Система изображений товаров
        const productImageSources = {
            primary: [
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph1.jpg',
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph2.jpg',
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph3.jpg',
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph4.jpg',
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph5.jpg',
                'https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/ph6.jpg'
            ],
            fallback: [
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup1&size=300&backgroundColor=0A0A0F',
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup2&size=300&backgroundColor=15151F',
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup3&size=300&backgroundColor=8B5CF6',
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup4&size=300&backgroundColor=FF2D75',
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup5&size=300&backgroundColor=00D4FF',
                'https://api.dicebear.com/9.x/shapes/svg?seed=Backup6&size=300&backgroundColor=FFD700'
            ],
            emoji: ['👕', '👖', '🧥', '👟', '🧢', '🎒']
        };

        // ==================== ОСНОВНЫЕ ФУНКЦИИ ====================

        function initGame() {
            console.log('🔄 Инициализация игры...');

            if (!document.getElementById('loading-screen') || !document.getElementById('clickButton')) {
                console.log('⏳ DOM не готов, откладываем запуск');
                setTimeout(initGame, 100);
                return;
            }

            console.log('✅ DOM готов, запускаем игру');

            // Инициализируем тему ДО симуляции загрузки
            initTheme();

            simulateLoading();
        }

        function simulateLoading() {
            console.log('🚀 Запуск игры с экраном загрузки...');

            const loadingScreen = document.getElementById('loading-screen');
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercentage = document.getElementById('loadingPercentage');

            if (!loadingScreen || !loadingBar || !loadingPercentage) {
                console.error('Элементы экрана загрузки не найдены');
                startGameDirectly();
                return;
            }

            let progress = 0;
            const duration = 1500; // 1.5 секунды
            const intervalTime = 15; // обновляем каждые 15 мс
            const steps = duration / intervalTime;
            const progressIncrement = 100 / steps;

            const interval = setInterval(() => {
                progress += progressIncrement;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    loadingBar.style.width = '100%';
                    loadingPercentage.textContent = '100%';

                    // Скрываем экран загрузки и запускаем игру
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        startGameDirectly();
                    }, 100);
                } else {
                    loadingBar.style.width = progress + '%';
                    loadingPercentage.textContent = Math.round(progress) + '%';
                }
            }, intervalTime);
        }

        function startGameDirectly() {
            console.log('🎮 Прямой запуск игры...');

            try {
                setupTelegram();
                setupEventListeners();

                loadUserData().then(() => {
                    console.log('✅ Данные загружены');
                    updateUI();
                    startRealTimeSystems();
                }).catch((error) => {
                    console.error('Ошибка загрузки данных:', error);
                    updateUI();
                    startRealTimeSystems();
                });

                const videoThumbnail = document.getElementById('videoThumbnail');
                if (videoThumbnail) {
                    videoThumbnail.src = "https://raw.githubusercontent.com/DANIL0372/kybnkgame/main/shop-images/video.jpg";
                }

            } catch (error) {
                console.error('❌ Ошибка при запуске игры:', error);
                emergencyStart();
            }
        }

        function emergencyStart() {
            console.log('🆘 Аварийный запуск...');

            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }

            try {
                setupTelegram();
                setupEventListeners();
                loadUserData();
                updateUI();
                startBasicIntervals();
            } catch (e) {
                console.error('❌ Критическая ошибка:', e);
            }
        }

        function setupTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.setBackgroundColor('#0A0A0F');
                console.log('Telegram WebApp initialized');

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    telegramUser = tg.initDataUnsafe.user;
                    userData.user_id = telegramUser.id.toString();
                    userData.username = telegramUser.username || telegramUser.first_name;

                    console.log('👤 Telegram User:', {
                        id: userData.user_id,
                        username: userData.username
                    });
                }
            }
        }

        function setupEventListeners() {
            const clickButton = document.getElementById('clickButton');
            if (clickButton) {
                clickButton.addEventListener('click', handleClick);
                console.log('✅ Click event listener attached');
            } else {
                console.error('❌ Click button not found');
            }

            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');

                    if (tabId === 'shop') {
                        loadShopItems();
                    } else if (tabId === 'profile') {
                        updateProfileTab();
                    }
                });
            });

            const avatarUploadInput = document.getElementById('avatarUploadInput');
            if (avatarUploadInput) {
                avatarUploadInput.addEventListener('change', handleAvatarUpload);
            }

            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    updateEnergyUI();
                    updateBoostUI();
                }
            });
        }

        // ==================== СИСТЕМЫ РЕАЛЬНОГО ВРЕМЕНИ ====================

        function startRealTimeSystems() {
            console.log('⏰ Запуск систем реального времени...');

            stopAllIntervals();

            startEnergySystem();
            startBoostSystem();
            startUIUpdateSystem();
            startAutoclicker();
            startAutoSave();

            console.log('✅ Все системы запущены');
        }

        function stopAllIntervals() {
            if (energyInterval) clearInterval(energyInterval);
            if (boostInterval) clearInterval(boostInterval);
            if (uiUpdateInterval) clearInterval(uiUpdateInterval);
            if (autoClickerInterval) clearInterval(autoClickerInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);

            energyInterval = null;
            boostInterval = null;
            uiUpdateInterval = null;
            autoClickerInterval = null;
            autoSaveInterval = null;
        }

        function startEnergySystem() {
            console.log('🔋 Запуск системы энергии...');

            updateEnergyInRealTime();
            updateEnergyUI();

            energyInterval = setInterval(() => {
                updateEnergyInRealTime();
                updateEnergyUI();
            }, 1000);
        }

        function startBoostSystem() {
            console.log('⚡ Запуск системы буста...');

            updateBoostUI();

            boostInterval = setInterval(() => {
                updateBoostUI();
            }, 1000);
        }

        function startUIUpdateSystem() {
            console.log('🔄 Запуск системы обновления UI...');

            uiUpdateInterval = setInterval(() => {
                updateBalanceDisplays();
                updateEnergyUI();
                updateBoostUI();
            }, 2000);
        }

        function startBasicIntervals() {
            console.log('🔧 Запуск базовых интервалов...');

            stopAllIntervals();

            energyInterval = setInterval(() => {
                try {
                    updateEnergyInRealTime();
                    updateEnergyUI();
                } catch (e) {}
            }, 1000);

            boostInterval = setInterval(() => {
                try {
                    updateBoostUI();
                } catch (e) {}
            }, 1000);
        }

        function startAutoclicker() {
            if (autoClickerInterval) {
                clearInterval(autoClickerInterval);
            }

            autoClickerInterval = setInterval(() => {
                if (userData.upgrades.autoclick > 0) {
                    const autoclickReward = userData.upgrades.autoclick * 0.5;
                    userData.balance += autoclickReward;
                    userData.clicks += userData.upgrades.autoclick;
                    userData.total_earned += autoclickReward;
                    updateLevel();
                    updateUI();
                    saveProgress();
                }
            }, 60000);
        }

        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }

            autoSaveInterval = setInterval(() => {
                saveProgress();
            }, 30000);

            window.addEventListener('beforeunload', saveProgress);
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveProgress();
                }
            });
        }

        // ==================== УМНАЯ СИСТЕМА ТОП-ИГРОКОВ ====================

        let smartTopPlayers = [];
        let lastTopUpdate = null;

        // ==================== УМНАЯ СИСТЕМА ТОП-ИГРОКОВ С ОГРАНИЧЕНИЕМ 1M ====================

        function loadSmartTopPlayers() {
            if (!userData.user_id) {
                showDefaultTop();
                return;
            }

            fetch(`/api/smart-top-players?user_id=${userData.user_id}&balance=${Math.floor(userData.balance)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        smartTopPlayers = data.players;
                        updateTopPlayersDisplay(); // ТОЛЬКО обновляем отображение топа

                        if (data.next_update) {
                            document.getElementById('nextUpdateTime').textContent = data.next_update;
                        }
                    } else {
                        showDefaultTop();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки топа:', error);
                    showDefaultTop();
                });
        }

        function updateTopProgressIndicator() {
            const userBalance = Math.floor(userData.balance);
            const thirdPlaceBalance = smartTopPlayers[2]?.balance || 500000;

            // Если пользователь в топе - полностью удаляем индикатор
            if (userBalance >= thirdPlaceBalance) {
                const indicator = document.getElementById('topProgressIndicator');
                if (indicator) {
                    indicator.remove();
                }
                return;
            }

            // Если не в топе - показываем прогресс
            const needed = thirdPlaceBalance - userBalance;
            const progress = Math.min(100, (userBalance / thirdPlaceBalance) * 100);

            let indicator = document.getElementById('topProgressIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'topProgressIndicator';
                indicator.style.cssText = `
                    margin: 10px 0;
                    padding: 8px 12px;
                    background: rgba(0, 212, 255, 0.1);
                    border-radius: 8px;
                    text-align: center;
                    font-size: 0.85em;
                    color: var(--accent-blue);
                    border: 1px solid rgba(0, 212, 255, 0.3);
                `;
                const ratingList = document.getElementById('smartRatingList');
                if (ratingList) {
                    ratingList.parentNode.insertBefore(indicator, ratingList.nextSibling);
                }
            }

            indicator.textContent = `🔄 Обновляется каждый час`;
            indicator.style.display = 'block';
        }

        function updateTopPlayersDisplay() {
            const container = document.getElementById('smartRatingList');
            if (!container) return;

            let html = '';

            smartTopPlayers.forEach((player, index) => {
                const medal = ['🥇', '🥈', '🥉'][index];
                const balance = player.balance;
                const isFirstPlace = index === 0;

                // Вычисляем разницу с предыдущим местом для визуализации
                let diffText = '';
                if (index > 0 && smartTopPlayers[index - 1]) {
                    const diff = smartTopPlayers[index - 1].balance - balance;

                }

                html += `
                    <div class="rating-item">
                        <div class="rating-user">
                            <span style="font-size: 1.1em; flex-shrink: 0;">${medal}</span>
                            <div style="display: flex; flex-direction: column;">
                                <span class="rating-username"
                                      style="${isFirstPlace ? 'color: #FFD700; font-weight: bold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);' : 'color: var(--accent-blue);'}">
                                    ${player.username}
                                </span>
                                ${diffText}
                            </div>
                        </div>
                        <span class="rating-balance" style="${isFirstPlace ? 'color: #FFD700; font-weight: bold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);' : 'color: white;'}">
                            ${formatBalance(balance)}
                            ${isFirstPlace ? ' 👑' : ''}
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showDefaultTop() {
            const container = document.getElementById('smartRatingList');
            if (!container) return;

            const randomNames = getRandomNames(3);
            const defaultPlayers = [
                { username: randomNames[0], balance: 985421 },
                { username: randomNames[1], balance: 763857 },
                { username: randomNames[2], balance: 542619 }
            ];

            let html = '';
            defaultPlayers.forEach((player, index) => {
                const medal = ['🥇', '🥈', '🥉'][index];
                const isFirstPlace = index === 0;

                html += `
                    <div class="rating-item">
                        <div class="rating-user">
                            <span style="font-size: 1.1em;">${medal}</span>
                            <span class="rating-username"
                                  style="${isFirstPlace ? 'color: #FFD700; font-weight: bold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);' : 'color: var(--accent-blue);'}">
                                ${player.username}
                            </span>
                        </div>
                        <span class="rating-balance" style="${isFirstPlace ? 'color: #FFD700; font-weight: bold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);' : 'color: white;'}">
                            ${formatBalance(player.balance)}
                            ${isFirstPlace ? ' 👑' : ''}
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getRandomNames(count) {
            const allNames = [
                "Константин", "GGD", "Свага", "DANISIMO", "Алинка",
                "Batt Bratt", "дишка", "Dasha", "Ванёчек", "Машка",
                "Denzl", "Валерия В...", "OLESYAO", "kkk", "nellisaaaa",
                "No name", "Ali", "Карен", "OG", "2k17"
            ];

            // Перемешиваем массив и берем первые count элементов
            const shuffled = [...allNames].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Добавим CSS для выделения топ-игроков
        const style = document.createElement('style');
        style.textContent = `
            .top-player {
                color: #FFD700 !important;
                font-weight: bold;
            }

            .million-class {
                color: #FFD700 !important;
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.7) !important;
            }

            #topProgressIndicator {
                transition: all 0.3s ease;
            }

            #topProgressIndicator:hover {
                background: rgba(0, 212, 255, 0.2) !important;
                border-color: var(--accent-blue) !important;
            }
        `;
        document.head.appendChild(style);

        function showDefaultTop() {
            const container = document.getElementById('smartRatingList');
            if (!container) return;

            let html = '';
            defaultPlayers.forEach((player, index) => {
                const medal = ['🥇', '🥈', '🥉'][index];
                const isNearMillion = player.balance > 950000;

                html += `
                    <div class="rating-item">
                        <div class="rating-user">
                            <span style="font-size: 1.1em;">${medal}</span>
                            <span class="rating-username ${isNearMillion ? 'top-player' : ''}">${player.username}</span>
                        </div>
                        <span class="rating-balance" style="${isNearMillion ? 'color: #FFD700; text-shadow: 0 0 10px gold;' : ''}">
                            ${formatBalance(player.balance)}
                            ${isNearMillion ? ' 👑' : ''}
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Также показываем индикатор прогресса
            updateTopProgressIndicator();
        }

        function formatBalance(balance) {
            return balance.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        function updateTopOnClick() {
            // Отправляем запрос на обновление топа при клике
            if (userData.user_id) {
                fetch('/api/update-top-on-click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userData.user_id,
                        balance: Math.floor(userData.balance)
                    })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          // Если мы на вкладке магазина, обновляем отображение
                          if (document.getElementById('shop-tab').classList.contains('active')) {
                              // Небольшая задержка для визуального эффекта
                              setTimeout(() => {
                                  loadSmartTopPlayers();
                              }, 1000);
                          }
                      }
                  })
                  .catch(error => console.error('Ошибка обновления топа:', error));
            }
        }

        // ==================== УПРАВЛЕНИЕ ДАННЫМИ ====================

        async function loadUserData() {
            console.log('🔄 Загружаем данные пользователя...');

            if (!userData.user_id) {
                console.log('❌ Нет user_id, используем localStorage');
                loadFromLocalStorage();
                return;
            }

            try {
                const response = await fetch(`/api/user/${userData.user_id}`);

                if (response.ok) {
                    const data = await response.json();

                    if (data.error) {
                        console.log('👤 Пользователь не найден в БД, создаем нового');
                        await createUserInDB();
                    } else {
                        console.log('✅ Данные загружены из БД:', data);
                        Object.assign(userData, data);

                        // Преобразуем JSON поля
                        if (typeof userData.upgrades === 'string') {
                            userData.upgrades = JSON.parse(userData.upgrades);
                        }
                        if (typeof userData.bonuses === 'string') {
                            userData.bonuses = JSON.parse(userData.bonuses);
                        }
                        if (typeof userData.boost === 'string') {
                            userData.boost = JSON.parse(userData.boost);
                        }

                        // Применяем сохраненную тему пользователя
                        if (userData.theme) {
                            switchTheme(userData.theme, false);
                        }

                        updateUI();
                    }
                } else {
                    console.log('❌ Ошибка загрузки из БД, используем localStorage');
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('❌ Ошибка сети:', error);
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('kybnk_user_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(userData, parsedData);
                    console.log('✅ Данные загружены из localStorage');
                }
            } catch (error) {
                console.error('❌ Ошибка загрузки из localStorage:', error);
            }
        }

        async function createUserInDB() {
            if (!userData.user_id) return;

            try {
                loadFromLocalStorage();

                const response = await fetch(`/api/user/${userData.user_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: userData.username,
                        balance: userData.balance,
                        level: userData.level,
                        level_name: userData.level_name,
                        discount: userData.discount,
                        clicks: userData.clicks,
                        total_earned: userData.total_earned,
                        referrals: userData.referrals,
                        passive_income: userData.passive_income,
                        upgrades: userData.upgrades,
                        bonuses: userData.bonuses,
                        energy: userData.energy,
                        max_energy: userData.max_energy,
                        last_energy_update: userData.last_energy_update,
                        last_passive_claim: userData.last_passive_claim,
                        boost: userData.boost
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('✅ Пользователь создан в БД');
                    saveToLocalStorage();
                } else {
                    console.error('❌ Ошибка создания пользователя:', data.error);
                }
            } catch (error) {
                console.error('❌ Ошибка создания пользователя:', error);
            }
        }

        async function saveUserData() {
            if (!userData.user_id) {
                saveToLocalStorage();
                return;
            }

            try {
                const response = await fetch(`/api/user/${userData.user_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: userData.username,
                        balance: userData.balance,
                        level: userData.level,
                        level_name: userData.level_name,
                        discount: userData.discount,
                        clicks: userData.clicks,
                        total_earned: userData.total_earned,
                        referrals: userData.referrals,
                        passive_income: userData.passive_income,
                        upgrades: userData.upgrades,
                        bonuses: userData.bonuses,
                        energy: userData.energy,
                        max_energy: userData.max_energy,
                        last_energy_update: userData.last_energy_update,
                        last_passive_claim: userData.last_passive_claim,
                        boost: userData.boost
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    console.error('❌ Ошибка сохранения в БД:', data.error);
                }

                saveToLocalStorage();

            } catch (error) {
                console.error('❌ Ошибка сети при сохранении:', error);
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('kybnk_user_data', JSON.stringify(userData));
            } catch (error) {
                console.error('❌ Ошибка сохранения в localStorage:', error);
            }
        }

        function saveProgress() {
            saveUserData();
        }

        // ==================== ИГРОВАЯ ЛОГИКА ====================

        function handleClick(event) {
            if (clickCooldown) return;

            const baseClickPower = userData.upgrades.click_power || 1;
            const boostMultiplier = userData.boost.active ? userData.boost.multiplier : 1;
            const totalClickPower = baseClickPower * boostMultiplier;

            updateEnergyInRealTime();

            if (!userData.boost.active && userData.energy < baseClickPower) {
                showReward('Недостаточно энергии!', true, 2000);
                return;
            }

            clickCooldown = true;
            createClickEffect(event);

            const baseReward = 1;
            const clickPowerBonus = (userData.upgrades.click_power || 1) - 1;
            const totalReward = (baseReward + clickPowerBonus) * boostMultiplier;

            if (!userData.boost.active) {
                userData.energy -= baseClickPower;
                userData.last_energy_update = Date.now();
            }

            userData.balance += totalReward;
            userData.clicks += 1;
            userData.total_earned += totalReward;

            updateLevel();
            updateUI();
            showFloatingReward(totalReward, event);

            // ВОССТАНОВЛЕНО: ОБНОВЛЯЕМ ТОП ПРИ КАЖДОМ КЛИКЕ
            updateTopOnClick();

            saveProgress();

            setTimeout(() => { clickCooldown = false; }, 100);
        }

        setInterval(() => {
            if (document.getElementById('shop-tab').classList.contains('active')) {
                loadSmartTopPlayers();
            }
        }, 3600000); // 5 минут

        // Также обновляем топ при переключении на вкладку магазина
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.dataset.tab === 'shop') {
                    setTimeout(loadSmartTopPlayers, 100); // Небольшая задержка для гарантии
                }
            });
        });

        function updateLevel() {
            const thresholds = [0, 1000, 3000, 6000, 10000, 15000, 21000, 28000, 36000, 45000, 55000];
            const levelNames = [
                "Новичок 🟢", "Ученик 🔵", "Любитель 🟣", "Опытный 🟡", "Мастер 🟠",
                "Эксперт 🔴", "Ветеран 🥉", "Профи 🥈", "Гуру 🥇", "Легенда 💎", "Божество 👑"
            ];

            let newLevel = 1;
            for (let i = thresholds.length - 1; i >= 0; i--) {
                if (userData.clicks >= thresholds[i]) {
                    newLevel = i + 1;
                    break;
                }
            }

            if (newLevel !== userData.level) {
                userData.level = newLevel;
                userData.level_name = levelNames[newLevel - 1];
                showReward(`🎉 Новый уровень: ${userData.level_name}!`, false, 3000);
            }

            const nextLevelThreshold = thresholds[newLevel] || thresholds[thresholds.length - 1];
            const currentLevelThreshold = thresholds[newLevel - 1] || 0;

            if (newLevel < thresholds.length) {
                userData.next_level_progress = ((userData.clicks - currentLevelThreshold) / (nextLevelThreshold - currentLevelThreshold)) * 100;
                userData.next_level_threshold = nextLevelThreshold;
            } else {
                userData.next_level_progress = 100;
                userData.next_level_threshold = thresholds[thresholds.length - 1];
            }
        }

        function updateEnergyInRealTime() {
            try {
                const now = Date.now();
                const lastUpdate = userData.last_energy_update || now;
                const secondsPassed = (now - lastUpdate) / 1000;

                if (secondsPassed >= 18) {
                    const energyToRestore = Math.floor(secondsPassed / 18);

                    if (energyToRestore > 0) {
                        const oldEnergy = userData.energy;
                        userData.energy = Math.min(userData.max_energy, userData.energy + energyToRestore);
                        userData.last_energy_update = now;

                        if (energyToRestore >= 3) {
                            saveProgress();
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка в updateEnergyInRealTime:', error);
            }
        }

        function activateBoost() {
            if (!userData.boost.available || userData.boost.active) return;

            const now = Date.now();
            userData.boost.active = true;
            userData.boost.available = false;
            userData.boost.lastUsed = now;
            userData.boost.endTime = now + BOOST_SETTINGS.DURATION;
            userData.boost.cooldownEnd = now + BOOST_SETTINGS.COOLDOWN;
            userData.boost.multiplier = BOOST_SETTINGS.MULTIPLIER;

            updateBoostUI();
            saveProgress();

            setTimeout(() => {
                if (userData.boost.active) {
                    deactivateBoost();
                }
            }, BOOST_SETTINGS.DURATION);
        }

        function deactivateBoost() {
            if (!userData.boost.active) return;

            userData.boost.active = false;
            userData.boost.multiplier = 1;

            updateBoostUI();
            saveProgress();
        }

        function buyUpgrade(type) {
            let price = 0;

            switch(type) {
                case 'click_power':
                    price = upgradePrices.click_power * userData.upgrades.click_power;
                    break;
                case 'passive':
                    price = upgradePrices.passive * ((userData.upgrades.passive || 0) + 1);
                    break;
                case 'autoclick':
                    price = upgradePrices.autoclick * ((userData.upgrades.autoclick || 0) + 1);
                    break;
                case 'energy_limit':
                    price = upgradePrices.energy_limit * ((userData.upgrades.energy_limit || 0) + 1);
                    break;
            }

            if (userData.balance < price) {
                showReward('Недостаточно токенов для покупки!', true, 3000);
                return;
            }

            if (maxLevels[type] && userData.upgrades[type] >= maxLevels[type]) {
                showReward('Достигнут максимальный уровень улучшения!', true, 3000);
                return;
            }

            userData.balance -= price;
            userData.upgrades[type] = (userData.upgrades[type] || 0) + 1;

            applyUpgradeEffects(type);

            updateUI();
            saveUserData();

            showReward(`Улучшение "${getUpgradeName(type)}" приобретено!`, false, 3000);
        }

        function getUpgradeName(type) {
            const names = {
                click_power: 'Улучшенный клик',
                passive: 'Пассивный доход',
                autoclick: 'Автокликер',
                energy_limit: 'Лимит энергии'
            };
            return names[type] || type;
        }

        function applyUpgradeEffects(type) {
            switch(type) {
                case 'energy_limit':
                    userData.max_energy = 100 + (userData.upgrades.energy_limit * 50);
                    userData.energy = Math.min(userData.energy, userData.max_energy);
                    break;
                case 'passive':
                    userData.passive_income = userData.upgrades.passive;
                    break;
            }
        }

        function subscribeAndClaimBonus(channel) {
            if (userData.bonuses[channel]) {
                showReward('Бонус уже получен!', true, 3000);
                return;
            }

            const channelLinks = {
                kybnk_show: 'https://t.me/kybnk_show',
                kybnk_shop: 'https://t.me/kybnk_shop'
            };

            window.open(channelLinks[channel], '_blank');

            userData.bonuses[channel] = true;
            userData.balance += 1000;
            userData.total_earned += 1000;

            updateUI();
            saveProgress();
            showReward('Бонус 1000 токенов получен!', false, 3000);
        }

        // ==================== ИНТЕРФЕЙС ====================

        function updateUI() {
            document.getElementById('balance').textContent = Math.floor(userData.balance);

            const upgradesBalance = document.getElementById('upgradesBalance');
            if (upgradesBalance) {
                upgradesBalance.textContent = Math.floor(userData.balance);
            }

            const levelBadge = document.querySelector('.level-badge');
            if (levelBadge) {
                levelBadge.textContent = userData.level_name;
            }

            document.getElementById('clicks').textContent = userData.clicks;
            document.getElementById('totalEarned').textContent = Math.floor(userData.total_earned);

            const progress = userData.next_level_progress || 0;
            document.getElementById('levelProgress').style.width = progress + '%';
            document.getElementById('levelProgressText').textContent = Math.floor(progress) + '% до след. уровня';

            document.getElementById('clickPowerLevel').textContent = userData.upgrades.click_power || 1;
            document.getElementById('passiveLevel').textContent = userData.upgrades.passive || 0;
            document.getElementById('autoclickLevel').textContent = userData.upgrades.autoclick || 0;
            document.getElementById('energyLimitLevel').textContent = userData.upgrades.energy_limit || 0;

            document.getElementById('clickPowerPrice').textContent = upgradePrices.click_power * (userData.upgrades.click_power || 1);
            document.getElementById('passivePrice').textContent = upgradePrices.passive * ((userData.upgrades.passive || 0) + 1);
            document.getElementById('autoclickPrice').textContent = upgradePrices.autoclick * ((userData.upgrades.autoclick || 0) + 1);
            document.getElementById('energyLimitPrice').textContent = upgradePrices.energy_limit * ((userData.upgrades.energy_limit || 0) + 1);

            updateUpgradeButtons();
            updateBonusButtons();

            updateProfileTab();
            updateEnergyUI();
            loadShopItems();
            updateBoostUI();

            updateAvatar();
        }

        function updateProfileTab() {
            document.getElementById('profileLevel').textContent = userData.level_name;
            document.getElementById('profileTotal').textContent = Math.floor(userData.total_earned) + ' токенов';
            document.getElementById('profileClicks').textContent = userData.clicks;
            document.getElementById('profileReferrals').textContent = userData.referrals;
            document.getElementById('profileNextLevel').textContent = userData.next_level_threshold + ' кликов';
        }

        function updateEnergyUI() {
            try {
                const energyBar = document.getElementById('energyBar');
                const energyText = document.getElementById('energyText');

                if (energyBar && energyText) {
                    const energyPercentage = Math.max(0, (userData.energy / userData.max_energy) * 100);
                    energyBar.style.width = energyPercentage + '%';
                    energyText.textContent = `${Math.floor(userData.energy)}/${userData.max_energy}`;
                }

                const clickButton = document.getElementById('clickButton');
                if (clickButton) {
                    const clickPower = userData.upgrades.click_power || 1;
                    if (userData.energy < clickPower && !userData.boost.active) {
                        clickButton.classList.add('disabled');
                    } else {
                        clickButton.classList.remove('disabled');
                    }
                }
            } catch (error) {
                console.error('Ошибка в updateEnergyUI:', error);
            }
        }

        function updateBoostUI() {
            try {
                const boostButton = document.getElementById('boostButton');
                const boostTimer = document.getElementById('boostTimer');
                const boostIndicator = document.getElementById('boostActiveIndicator');

                if (!boostButton || !boostTimer) return;

                const now = Date.now();
                const boost = userData.boost;

                if (boost.active && boost.endTime > now) {
                    const timeLeft = Math.max(0, boost.endTime - now);
                    const secondsLeft = Math.ceil(timeLeft / 1000);

                    boostButton.classList.add('active');
                    boostButton.disabled = true;
                    boostTimer.innerHTML = `<div class="boost-active-timer">${secondsLeft}с</div>`;

                    if (boostIndicator) {
                        boostIndicator.classList.add('active');
                    }

                    if (timeLeft <= 0) {
                        deactivateBoost();
                    }
                } else {
                    boostButton.classList.remove('active');

                    if (boostIndicator) {
                        boostIndicator.classList.remove('active');
                    }

                    if (boost.available) {
                        boostButton.disabled = false;
                        boostTimer.textContent = 'Готово!';
                    } else {
                        boostButton.disabled = true;
                        const timeLeft = Math.max(0, boost.cooldownEnd - now);
                        if (timeLeft > 0) {
                            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                            boostTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        } else {
                            userData.boost.available = true;
                            boostTimer.textContent = 'Готово!';
                            boostButton.disabled = false;
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка в updateBoostUI:', error);
            }
        }

        function updateBalanceDisplays() {
            try {
                const balanceElements = [
                    document.getElementById('balance'),
                    document.getElementById('upgradesBalance')
                ];

                balanceElements.forEach(element => {
                    if (element) {
                        element.textContent = Math.floor(userData.balance);
                    }
                });
            } catch (error) {
                console.error('Ошибка в updateBalanceDisplays:', error);
            }
        }

        function updateUpgradeButtons() {
            const upgrades = ['click_power', 'passive', 'autoclick', 'energy_limit'];

            upgrades.forEach(type => {
                const button = document.getElementById(`${type}Button`);
                if (!button) return;

                let price = 0;
                switch(type) {
                    case 'click_power':
                        price = upgradePrices.click_power * userData.upgrades.click_power;
                        break;
                    case 'passive':
                        price = upgradePrices.passive * ((userData.upgrades.passive || 0) + 1);
                        break;
                    case 'autoclick':
                        price = upgradePrices.autoclick * ((userData.upgrades.autoclick || 0) + 1);
                        break;
                    case 'energy_limit':
                        price = upgradePrices.energy_limit * ((userData.upgrades.energy_limit || 0) + 1);
                        break;
                }

                if (maxLevels[type] && userData.upgrades[type] >= maxLevels[type]) {
                    button.disabled = true;
                    button.innerHTML = '✅ Вы достигли максимального уровня';
                    button.style.background = 'var(--bg-secondary)';
                    button.style.color = 'var(--text-secondary)';
                    button.style.cursor = 'not-allowed';
                } else {
                    button.disabled = false;
                    button.innerHTML = `Купить за <span id="${type}Price">${price}</span> токенов`;
                    button.style.background = 'linear-gradient(135deg, var(--accent-blue), var(--accent-pink))';
                    button.style.color = 'white';
                    button.style.cursor = 'pointer';

                    if (userData.balance >= price) {
                        button.disabled = false;
                    } else {
                        button.disabled = true;
                        button.style.background = 'var(--bg-secondary)';
                        button.style.color = 'var(--text-secondary)';
                    }
                }
            });
        }

        function updateBonusButtons() {
            const bonusButtons = {
                kybnk_show: document.getElementById('bonusKybnkShow'),
                kybnk_shop: document.getElementById('bonusKybnkShop')
            };

            for (const [channel, button] of Object.entries(bonusButtons)) {
                if (button) {
                    if (userData.bonuses[channel]) {
                        button.disabled = true;
                        button.textContent = 'Бонус получен ✓';
                        button.style.background = 'var(--bg-secondary)';
                        button.style.color = 'var(--text-secondary)';
                    } else {
                        button.disabled = false;
                        button.textContent = 'Получить 1000 токенов';
                        button.style.background = 'linear-gradient(135deg, var(--accent-blue), var(--accent-pink))';
                        button.style.color = 'white';
                    }
                }
            }
        }

        // ==================== АВАТАРЫ ====================

        function updateAvatar() {
            updateAvatarDisplay();
        }

        function updateAvatarDisplay() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarPlaceholder = document.getElementById('avatarPlaceholder');

            if (!avatarImage || !avatarPlaceholder) return;

            if (userData.avatar) {
                avatarImage.src = userData.avatar;
                avatarImage.style.display = 'block';
                avatarPlaceholder.style.display = 'none';

                avatarImage.onerror = function() {
                    console.error('Ошибка отображения аватара');
                    avatarImage.style.display = 'none';
                    avatarPlaceholder.style.display = 'flex';
                };

                avatarImage.onload = function() {
                    console.log('Аватар успешно загружен и отображен');
                };
            } else {
                avatarImage.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.match('image.*')) {
                showReward('Пожалуйста, выберите изображение!', true, 3000);
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showReward('Изображение слишком большое! Максимум 5MB', true, 3000);
                return;
            }

            showReward('Загружаем изображение...', false, 2000);

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const img = new Image();

                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        const MAX_SIZE = 400;
                        let { width, height } = img;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height = Math.round((height * MAX_SIZE) / width);
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width = Math.round((width * MAX_SIZE) / height);
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        ctx.drawImage(img, 0, 0, width, height);

                        const processedImageData = canvas.toDataURL('image/jpeg', 0.85);

                        userData.avatar = processedImageData;

                        updateAvatarDisplay();

                        saveProgress();

                        event.target.value = '';

                        showReward('Аватар успешно обновлен!', false, 3000);
                    };

                    img.onerror = function() {
                        console.error('Ошибка загрузки изображения');
                        showReward('Ошибка загрузки изображения!', true, 3000);
                        event.target.value = '';
                    };

                    img.src = e.target.result;

                } catch (error) {
                    console.error('Ошибка обработки изображения:', error);
                    showReward('Ошибка обработки изображения!', true, 3000);
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                console.error('Ошибка чтения файла');
                showReward('Ошибка чтения файла!', true, 3000);
                event.target.value = '';
            };

            reader.readAsDataURL(file);
        }

        // ==================== МАГАЗИН ====================

        function loadShopItems() {
            const shopItems = [
                {
                    id: 1,
                    name: "Свитер унисекс",
                    description: "Универсальная модель на каждый день - подходит под джинсы, брюки или юбку. Состояние отличное, без дефектов. Много размеров в наличии",
                    price: 1390,
                    category: "sweater",
                    url: "https://vk.com/market-229340092?w=product-229340092_11934320"
                },
                {
                    id: 2,
                    name: "Куртка унисекс",
                    description: "Стильная куртка в гоночном стиле Ferrari. Отлично смотрится в повседневных образах и выделяется из толпы. Состояние хорошее, молнии работают",
                    price: 6990,
                    category: "jacket",
                    url: "https://vk.com/market-229340092?w=product-229340092_11938759"
                },
                {
                    id: 3,
                    name: "Куртка Lonsdale, мужская",
                    description: "Куртка с аккуратной посадкой - смотрится дорого и универсально под любой образ. Материал плотный, держит форму, внутри комфортная подкладка. Отличный вариант для межсезонья",
                    price: 4090,
                    category: "jacket",
                    url: "https://vk.com/market-229340092?w=product-229340092_11938575"
                },
                {
                    id: 4,
                    name: "Кеды Puma, женские",
                    description: "Лёгкие и удобные кеды - подходят для прогулок, учёбы и повседневных образов. Белый цвет с контрастной вставкой смотрится очень свежо и универсально. \nРазмер - 38",
                    price: 5390,
                    category: "sneakers",
                    url: "https://vk.com/market-229340092?w=product-229340092_12240206"
                },
                {
                    id: 5,
                    name: "Полузамок Lacoste, мужской",
                    description: "Классический чёрный цвет, культовый логотип на груди. Подойдёт под любой стиль - от casual до более строго. Материал мягкий, приятный к телу, много размеров в наличии",
                    price: 3490,
                    category: "sweater",
                    url: "https://vk.com/market-229340092?w=product-229340092_12179337"
                },
                {
                    id: 6,
                    name: "Полузамок Polo Ralph Lauren, мужской",
                    description: "Подчёркивает образ без лишнего шума. Плотный, качесвтенный материал, удобная посадка и фирменный аккуратный логотип, который сраху бросается в глаза",
                    price: 3490,
                    category: "sweater",
                    url: "https://vk.com/market-229340092?w=product-229340092_12179325"
                }
            ];

            renderShopItems(shopItems);
            // Загружаем умный топ игроков
            loadSmartTopPlayers();
        }

        function getProductImage(index, type = 'primary') {
            const sources = productImageSources[type];
            const imageIndex = index % sources.length;

            if (type === 'emoji') {
                return {
                    type: 'emoji',
                    source: sources[imageIndex],
                    alt: `Товар ${index + 1}`
                };
            }

            const timestamp = Date.now();
            return {
                type: 'svg',
                source: sources[imageIndex] + (sources[imageIndex].includes('?') ? '&' : '?') + 't=' + timestamp,
                alt: `Товар ${index + 1}`
            };
        }

        function handleImageError(imgElement, productIndex = null, retryCount = 0) {
            console.log('Ошибка загрузки изображения, попытка:', retryCount + 1);

            const container = imgElement.parentElement;
            const maxRetries = 1;

            if (retryCount >= maxRetries) {
                container.classList.add('image-error', 'fallback');
                container.innerHTML = '';

                if (productIndex !== null) {
                    const emojiSource = getProductImage(productIndex, 'emoji');
                    const emojiElement = document.createElement('div');
                    emojiElement.textContent = emojiSource.source;
                    emojiElement.style.cssText = `
                        font-size: 3em;
                        opacity: 0.7;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 100%;
                        height: 100%;
                    `;
                    container.appendChild(emojiElement);
                } else {
                    container.innerHTML = '<div style="font-size: 3em; opacity: 0.7; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">📦</div>';
                }
                return;
            }

            if (productIndex !== null) {
                const nextSourceType = retryCount === 0 ? 'fallback' : 'emoji';
                const newSource = getProductImage(productIndex, nextSourceType);

                if (newSource.type === 'svg' || newSource.type === 'image') {
                    imgElement.src = newSource.source;
                    imgElement.style.opacity = '0';
                    imgElement.onload = function() {
                        this.style.opacity = '1';
                        container.classList.remove('image-loading');
                    };
                    imgElement.onerror = function() {
                        handleImageError(this, productIndex, retryCount + 1);
                    };
                } else {
                    handleImageError(imgElement, productIndex, maxRetries);
                }
            }
        }

        function renderShopItems(items) {
            const container = document.getElementById('shop-items');
            if (!container) return;

            container.innerHTML = '';

            items.forEach((item, index) => {
                const imageSource = getProductImage(index, 'primary');
                const itemElement = document.createElement('div');
                itemElement.className = 'shop-item';

                let imageHtml = '';
                if (imageSource.type === 'svg' || imageSource.type === 'image') {
                    imageHtml = `
                        <img src="${imageSource.source}"
                             alt="${item.name}"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onload="this.style.opacity='1'"
                             onerror="handleImageError(this, ${index})">
                    `;
                } else if (imageSource.type === 'emoji') {
                    imageHtml = `<div style="font-size: 3em; opacity: 0.7; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">${imageSource.source}</div>`;
                }

                itemElement.innerHTML = `
                    <div class="square-image">
                        ${imageHtml}
                    </div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-description">${item.description}</div>
                    <div class="shop-item-price">${item.price.toLocaleString()} ₽</div>
                    <button class="shop-button"
                            onclick="openProductLink('${item.url}')"
                            id="shop-btn-${item.id}">
                        Перейти к товару
                    </button>
                `;

                container.appendChild(itemElement);
            });

            updateShopButtons();
        }

        function updateShopButtons() {
            const buttons = document.querySelectorAll('.shop-button');
            buttons.forEach(button => {
                button.disabled = false;
                button.style.background = 'linear-gradient(135deg, var(--accent-blue), var(--accent-pink))';
                button.style.color = 'white';
                button.style.cursor = 'pointer';
            });
        }

        // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================

        function createClickEffect(event) {
            const clickArea = document.getElementById('clickButton');
            const rect = clickArea.getBoundingClientRect();

            let x, y;
            if (event.type.includes('touch')) {
                x = event.touches[0].clientX - rect.left;
                y = event.touches[0].clientY - rect.top;
            } else {
                x = event.clientX - rect.left;
                y = event.clientY - rect.top;
            }

            const effect = document.createElement('div');
            effect.className = 'click-effect';
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            effect.style.width = '50px';
            effect.style.height = '50px';

            clickArea.appendChild(effect);

            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 500);
        }

        function showFloatingReward(reward, event) {
            const clickArea = document.getElementById('clickButton');
            const rect = clickArea.getBoundingClientRect();

            let x, y;
            if (event.type.includes('touch')) {
                x = event.touches[0].clientX - rect.left;
                y = event.touches[0].clientY - rect.top;
            } else {
                x = event.clientX - rect.left;
                y = event.clientY - rect.top;
            }

            const rewardElement = document.createElement('div');
            rewardElement.className = 'floating-reward';
            rewardElement.textContent = `+${reward}`;
            rewardElement.style.left = x + 'px';
            rewardElement.style.top = y + 'px';

            clickArea.appendChild(rewardElement);

            setTimeout(() => {
                if (rewardElement.parentNode) {
                    rewardElement.parentNode.removeChild(rewardElement);
                }
            }, 1000);
        }

        function showReward(text, isError = false, duration = 3000) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                padding: 15px 25px;
                border-radius: 15px;
                font-size: 1.3em;
                font-weight: bold;
                z-index: 1000;
                color: ${isError ? '#FF6B6B' : 'var(--accent-blue)'};
                border: 1px solid ${isError ? 'rgba(255, 107, 107, 0.5)' : 'var(--accent-blue)'};
            `;
            popup.textContent = text;

            document.body.appendChild(popup);

            setTimeout(() => {
                if (document.body.contains(popup)) {
                    document.body.removeChild(popup);
                }
            }, duration);
        }

        function closeAllPopups() {
            const popups = document.querySelectorAll('.popup-overlay');
            popups.forEach(popup => popup.remove());
            currentBonusChannel = null;
        }

        // ==================== ВНЕШНИЕ ССЫЛКИ ====================

        function openFullCatalog() {
            window.location.href = 'https://vk.com/market-229340092?screen=group';
        }

        function openVideo() {
            const videoUrl = 'https://vk.com/video-229340092_456239080';

            const a = document.createElement('a');
            a.href = videoUrl;
            a.target = '_blank';
            a.rel = 'noopener,noreferrer';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function openProductLink(url) {
            if (!url || url === 'https://example.com/product1') {
                showReward('Ссылка на товар не настроена!', true, 3000);
                return;
            }

            window.open(url, '_blank');
        }

        function exchangeForTokens() {
            const itemName = "ТОВАР ЗА ТОКЕНЫ";
            const itemPrice = 1200000;

            if (userData.balance < itemPrice) {
                showReward('Недостаточно токенов для обмена!', true, 3000);
                return;
            }

            const message = `Здравствуйте! Я хочу обменять токены на товар недели.

🎁 Выбранный товар: ${itemName}
💰 Цена товара: ${itemPrice.toLocaleString()} токенов

📊 Мои данные в игре:
• Текущий баланс: ${Math.floor(userData.balance)} токенов
• Уровень: ${userData.level_name}
• Всего заработано: ${Math.floor(userData.total_earned)} токенов

✅ Подтверждаю обмен и согласен на списание ${itemPrice.toLocaleString()} токенов с моего баланса.`;

            openTelegramChat(message);
        }

        function showReferral() {
            closeAllPopups();

            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">👥 Реферальная программа</div>
                    <p style="margin-bottom: 15px; text-align: center; color: var(--text-primary);">Приглашайте друзей и получайте бонусы!</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin: 10px 0; word-break: break-all; text-align: center; color: var(--text-primary);">
                        https://t.me/kybnk_show_bot?start=ref_${userData.user_id || '12345'}
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-button" onclick="copyToClipboard('https://t.me/kybnk_show_bot?start=ref_${userData.user_id || '12345'}')">📋 Копировать</button>
                        <button class="popup-button" onclick="shareReferralLink()">📤 Поделиться</button>
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-button secondary" onclick="closeAllPopups()">Закрыть</button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);
        }

        function showExchange() {
            closeAllPopups();

            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">💎 Обмен токенов</div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0; text-align: left; color: var(--text-primary);">
                        <strong>Ваши данные:</strong><br><br>
                        💰 Текущий баланс: <strong style="color: var(--accent-blue);">${Math.floor(userData.balance)} токенов</strong><br>
                        🎯 Уровень: <strong style="color: var(--accent-blue);">${userData.level_name}</strong><br>
                        📈 Всего заработано: <strong style="color: var(--accent-blue);">${Math.floor(userData.total_earned)} токенов</strong>
                    </div>
                    <div style="text-align: center; margin: 15px 0; color: var(--text-primary);">
                        <strong>Курс обмена:</strong><br>
                        1000 токенов = 100 рублей скидки<br>
                        5000 токенов = 600 рублей скидки<br>
                        10000 токенов = 1300 рублей скидки
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-button" onclick="sendExchangeRequest()">📨 Отправить заявку</button>
                    </div>
                    <div class="popup-buttons">
                        <button class="popup-button secondary" onclick="closeAllPopups()">Закрыть</button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);
        }

        function sendExchangeRequest() {
            const message = `Здравствуйте! Хочу обменять токены на скидку.

📊 Мои данные в игре:
• Текущий баланс: ${Math.floor(userData.balance)} токенов
• Уровень: ${userData.level_name}
• Всего заработано: ${Math.floor(userData.total_earned)} токенов

💎 Хочу обменять токены по следующему курсу:
• 1000 токенов = 100 рублей скидки
• 5000 токенов = 600 рублей скидки
• 10000 токенов = 1300 рублей скидки

✅ Подтверждаю запрос на обмен.`.trim();

            openTelegramChat(message);
        }

        function openTelegramChat(message) {
            const encodedMessage = encodeURIComponent(message);
            const telegramUrl = `https://t.me/kybnkshop?text=${encodedMessage}`;

            const popup = document.getElementById('preparationPopup');
            if (popup) {
                popup.style.display = 'flex';
            }

            setTimeout(() => {
                if (popup) {
                    popup.style.display = 'none';
                }

                if (window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.openTelegramLink(telegramUrl);
                } else {
                    window.open(telegramUrl, '_blank', 'noopener,noreferrer');
                }
            }, 2000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showReward('Ссылка скопирована!', false, 3000);
            });
        }

        function shareReferralLink() {
            const link = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/kybnk_show_bot')}&text=${encodeURIComponent('Присоединяйся к KYBNK GAME, получайте токены и обменивайте их на скидки или товары в нашем магазине!')}`;
            window.open(link, '_blank');
        }

        function showLevelsInfo() {
            closeAllPopups();

            const levels = [
                { level: 1, name: "Новичок 🟢", clicks: 0 },
                { level: 2, name: "Ученик 🔵", clicks: 1000 },
                { level: 3, name: "Любитель 🟣", clicks: 3000 },
                { level: 4, name: "Опытный 🟡", clicks: 6000 },
                { level: 5, name: "Мастер 🟠", clicks: 10000 },
                { level: 6, name: "Эксперт 🔴", clicks: 15000 },
                { level: 7, name: "Ветеран 🥉", clicks: 21000 },
                { level: 8, name: "Профи 🥈", clicks: 28000 },
                { level: 9, name: "Гуру 🥇", clicks: 36000 },
                { level: 10, name: "Легенда 💎", clicks: 45000 },
                { level: 11, name: "Божество 👑", clicks: 55000 }
            ];

            let levelsHtml = '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
            levels.forEach(levelInfo => {
                const isCurrent = levelInfo.level === userData.level;
                levelsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); ${isCurrent ? 'background: rgba(0, 212, 255, 0.1); border-radius: 5px; padding: 8px; margin: 2px 0;' : ''}">
                        <span style="color: var(--text-primary);">${levelInfo.level}. ${levelInfo.name}</span>
                        <span style="color: var(--accent-blue);">${levelInfo.clicks} к.</span>
                    </div>
                `;
            });
            levelsHtml += '</div>';

            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-header">🚀 Система уровней</div>
                    ${levelsHtml}
                    <div class="popup-buttons">
                        <button class="popup-button secondary" onclick="closeAllPopups()">Закрыть</button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);
        }

        // ==================== ЗАПУСК ПРИЛОЖЕНИЯ ====================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            initGame();
        }

        setTimeout(() => {
            if (!window.gameStarted) {
                console.log('🕒 Резервный запуск...');
                initGame();
            }
        }, 2000);

        window.addEventListener('error', function(event) {
            console.error('🚨 Глобальная ошибка:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('🚨 Необработанный промис:', event.reason);
        });

        // ==================== СИСТЕМА ТЕМ ====================

        let currentTheme = 'dark';

        // Инициализация темы при загрузке
        function initTheme() {
            // Проверяем сохраненную тему в localStorage
            const savedTheme = localStorage.getItem('kybnk_theme');
            if (savedTheme) {
                switchTheme(savedTheme, false); // false = не сохраняем (уже сохранено)
            }

            // Если пользователь есть, проверяем его тему
            if (userData.user_id && userData.theme) {
                switchTheme(userData.theme, false);
            }
        }

        // Переключение темы
        function switchTheme(theme, saveToServer = true) {
            // Удаляем все классы тем
            document.body.classList.remove('light-theme', 'dark-theme', 'neon-theme');

            // Добавляем выбранную тему
            document.body.classList.add(theme + '-theme');

            // Обновляем активную кнопку
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });

            // Сохраняем в localStorage
            localStorage.setItem('kybnk_theme', theme);
            currentTheme = theme;

            // Обновляем данные пользователя
            if (userData.user_id && saveToServer) {
                userData.theme = theme;
                saveThemeToServer(theme);
            }

            console.log(`✅ Тема изменена: ${theme}`);
        }

        // Сохранение темы на сервере
        async function saveThemeToServer(theme) {
            if (!userData.user_id) return;

            try {
                const response = await fetch(`/api/user/${userData.user_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...userData,
                        theme: theme
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`✅ Тема сохранена на сервере: ${theme}`);
                }
            } catch (error) {
                console.error('❌ Ошибка сохранения темы:', error);
            }
        }

        // Функция для получения текущей темы
        function getCurrentTheme() {
            return currentTheme;
        }

    </script>
</body>
</html>